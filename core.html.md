# core


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

### Introduction

We often have to go through a whole bunch of hoops to get documents
processed and ready for searching through them. `litesearch` plans to
make this as easy as possible by providing simple building blocks to set
up a database with FTS5 and vector search capabilities.

    /opt/hostedtoolcache/Python/3.10.19/x64/lib/python3.10/site-packages/usearch/__init__.py:125: UserWarning: Will download `usearch_sqlite` binary from GitHub.
      warnings.warn("Will download `usearch_sqlite` binary from GitHub.", UserWarning)

------------------------------------------------------------------------

<a
href="https://github.com/Karthik777/litesearch/blob/main/litesearch/core.py#L14"
target="_blank" style="float:right; font-size:smaller">source</a>

### Database.query

>  Database.query (sql:str, params:Union[Iterable,dict,NoneType]=None)

*Execute a query and return results as a list of AttrDict*

> Simple Docs table setup

------------------------------------------------------------------------

<a
href="https://github.com/Karthik777/litesearch/blob/main/litesearch/core.py#L23"
target="_blank" style="float:right; font-size:smaller">source</a>

### Database.get_store

>  Database.get_store (name:str='store', hash:bool=False, **kw)

*Make a sql table for content storage with FTS5 and vector search
capabilities*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>str</td>
<td>store</td>
<td>table name</td>
</tr>
<tr>
<td>hash</td>
<td>bool</td>
<td>False</td>
<td>whether to create hash index on content</td>
</tr>
<tr>
<td>kw</td>
<td>VAR_KEYWORD</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/Karthik777/litesearch/blob/main/litesearch/core.py#L37"
target="_blank" style="float:right; font-size:smaller">source</a>

### database

>  database (pth_or_uri:str=':memory:', wal:bool=True, sem_search:bool=True,
>                **kw)

*Set up a database connection and load usearch extensions.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>pth_or_uri</td>
<td>str</td>
<td>:memory:</td>
<td>the database name or URL</td>
</tr>
<tr>
<td>wal</td>
<td>bool</td>
<td>True</td>
<td>use WAL mode</td>
</tr>
<tr>
<td>sem_search</td>
<td>bool</td>
<td>True</td>
<td>enable usearch extensions</td>
</tr>
<tr>
<td>kw</td>
<td>VAR_KEYWORD</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Database</strong></td>
<td></td>
<td><strong>additional args to pass to apswutils database</strong></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/Karthik777/litesearch/blob/main/litesearch/core.py#L56"
target="_blank" style="float:right; font-size:smaller">source</a>

### Database.search

>  Database.search (q:str, emb:bytes, columns:list=None, where:str=None,
>                       where_args:dict=None, limit:int|None=50,
>                       offset:int|None=None, table_name='store',
>                       emb_col='embedding', emb_metric:str='cosine', rrf=True,
>                       dtype=<class 'numpy.float16'>)

*Search the litesearch store with fts and vector search combined.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>q</td>
<td>str</td>
<td></td>
<td>query string</td>
</tr>
<tr>
<td>emb</td>
<td>bytes</td>
<td></td>
<td>embedding vector</td>
</tr>
<tr>
<td>columns</td>
<td>list</td>
<td>None</td>
<td>columns to return</td>
</tr>
<tr>
<td>where</td>
<td>str</td>
<td>None</td>
<td>additional where clause</td>
</tr>
<tr>
<td>where_args</td>
<td>dict</td>
<td>None</td>
<td>args for where clause</td>
</tr>
<tr>
<td>limit</td>
<td>int | None</td>
<td>50</td>
<td>limit on number of results</td>
</tr>
<tr>
<td>offset</td>
<td>int | None</td>
<td>None</td>
<td>offset for results</td>
</tr>
<tr>
<td>table_name</td>
<td>str</td>
<td>store</td>
<td>table name</td>
</tr>
<tr>
<td>emb_col</td>
<td>str</td>
<td>embedding</td>
<td>embedding column name</td>
</tr>
<tr>
<td>emb_metric</td>
<td>str</td>
<td>cosine</td>
<td>embedding distance metric (cosine,sqeuclidean,inner,divergence)</td>
</tr>
<tr>
<td>rrf</td>
<td>bool</td>
<td>True</td>
<td>need to rerank results with reciprocal rank fusion</td>
</tr>
<tr>
<td>dtype</td>
<td>type</td>
<td>float16</td>
<td>embedding dtype</td>
</tr>
</tbody>
</table>

Let’s test it out. We will create a database, run embedding comparisons,
create a store and run search

``` python
db = database()
```

The fastlite database is set up with usearch extensions. Let’s run some
distance calculations.

``` python
embs = dict(
    v1=np.ones((100,),dtype=np.float32).tobytes(),      # vector of ones
    v2=np.zeros((100,),dtype=np.float32).tobytes(),     # vector of zeros
    v3=np.full((100,),0.25,dtype=np.float32).tobytes()  # vector of 0.25s
)
def dist_q(metric):
    return db.q(f'''
        select
            distance_{metric}_f32(:v1,:v2) as {metric}_v1_v2,
            distance_{metric}_f32(:v1,:v3) as {metric}_v1_v3,
            distance_{metric}_f32(:v2,:v3) as {metric}_v2_v3
    ''', embs)

for fn in ['sqeuclidean', 'divergence', 'inner', 'cosine']: print(dist_q(fn))
```

    [{'sqeuclidean_v1_v2': 100.0, 'sqeuclidean_v1_v3': 56.25, 'sqeuclidean_v2_v3': 6.25}]
    [{'divergence_v1_v2': 34.657352447509766, 'divergence_v1_v3': 12.046551704406738, 'divergence_v2_v3': 8.66433334350586}]
    [{'inner_v1_v2': 1.0, 'inner_v1_v3': -24.0, 'inner_v2_v3': 1.0}]
    [{'cosine_v1_v2': 1.0, 'cosine_v1_v3': 0.0, 'cosine_v2_v3': 1.0}]

``` python
db.get_store()
if 'store' in db.t: print('store is created')
print('detected fts table: ',db.t.store.detect_fts())
print('Search results:', len(db.search('h',np.zeros((100,)).tobytes()))) # there is no data yet, so should be 0
```

    store is created
    detected fts table:  store_fts
    Search results: 0

We can also create a store with hash index on content. Useful for code
search applications

``` python
st=db.get_store(name='my_store', hash=True)
st.insert_all([dict(content='hello world', embedding=np.ones((100,),dtype=np.float16).tobytes()),
                           dict(content='hi there', embedding=np.full((100,),0.5,dtype=np.float16).tobytes()),
                           dict(content='goodbye now', embedding=np.zeros((100,),dtype=np.float16).tobytes())],upsert=True,hash_id='id')
st(select='id,content')
```

    [{'id': '250ce2bffa97ab21fa9ab2922d19993454a0cf28', 'content': 'hello world'},
     {'id': 'c89f43361891bfab9290bcebf182fa5978f89700', 'content': 'hi there'},
     {'id': '882293d5e5c3d3e04e8e0c4f7c01efba904d0932', 'content': 'goodbye now'}]

Let’s run a search again.

``` python
db.search(q='hello', emb=np.full((100,),0.25, dtype=np.float16).tobytes(), columns=['content'], table_name='my_store',limit=2, rrf=False)
```

    {'fts': [{'content': 'hello world'}],
     'vec': [{'content': 'hello world'}, {'content': 'hi there'}]}

Now, let’s try the same but with a broader query.

``` python
db.search(q='goodbye OR hi', emb=np.full((100,),0,dtype=np.float16).tobytes(), columns=['content'], table_name='my_store',limit=2)
```

    [{'content': 'goodbye now'}, {'content': 'hello world'}]

You can use different kind of embedding metrics as well. The default is
`cosine`. Let’s try with `divergence` distance

``` python
db.search(q='goodbye OR hi', emb=np.full((100,),0,dtype=np.float16).tobytes(), columns=['content'], table_name='my_store',limit=2, emb_metric='divergence')
```

    [{'content': 'goodbye now'}, {'content': 'hi there'}]
